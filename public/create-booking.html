<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Booking</title>
    <!-- Bootstrap CSS -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >
    <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }

        .text-primary {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background: linear-gradient(to right, #0371e7, #012041);
            color: white;
            border-radius: 0.5rem 0.5rem 0 0;
            padding: 20px;
            letter-spacing: 2px;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar {
            height: 100vh;
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            background: linear-gradient(135deg, #140303, #007bff);
            padding-top: 20px;
            color: white;
            overflow-y: auto;
        }

        .sidebar a {
            text-decoration: none;
            font-size: 1.1rem;
            padding: 10px 20px;
            display: block;
            color: white;
            border-radius: 4px;
        }

        .sidebar a:hover {
            background-color: #007bff;
            color: white;
        }

        .sidebar-section-title {
            font-size: 1rem;
            color: #b0b0b0;
            padding: 5px 20px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .ms-3 {
            margin-left: 1rem;
        }

        .content {
            margin-left: 260px;
            padding: 20px;
        }

        .form-control {
            border-radius: 8px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            border-radius: 8px;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .remove-traveler-btn {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar d-flex flex-column justify-content-between">
        <div>
          <!-- Home -->
          <a href="index.html" class="sidebar-link"
            ><i class="fas fa-home me-2"></i>Home</a
          >
  
          <!-- Spacing -->
          <div class="mt-5"></div>
  
          <!-- Product Area -->
          <div class="sidebar-section-title">Product Area</div>
          <a href="product-area.html" class="sidebar-link ms-3"
            ><i class="fa-solid fa-plus"></i> New Experience</a
          >
  
          <!-- Spacing -->
          <div class="mt-5"></div>
  
          <!-- Tours Section -->
          <div class="sidebar-section-title">Tours</div>
          <a href="tour-management.html" class="sidebar-link ms-3"
            ><i class="fa-solid fa-plus"></i> Add a New Tour</a
          >
          <a href="available-tours.html" class="sidebar-link ms-3"
            ><i class="fas fa-list me-2"></i>Available Tours</a
          >
  
          <!-- Spacing -->
          <div class="mt-5"></div>
  
          <!-- Bookings Section -->
          <div class="sidebar-section-title">Travel Agent Area</div>
          <a href="create-booking.html" class="sidebar-link ms-3"
            ><i class="fa-solid fa-calendar-check"></i> Create Booking</a
          >
          <a href="view-bookings.html" class="sidebar-link ms-3"
            ><i class="fas fa-list me-2"></i>View Bookings</a
          >
  
          <div class="mt-5"></div>
  
          <!-- External Booking Section -->
          <div class="sidebar-section-title">Customers Portal</div>
          <a href="external-booking.html" class="sidebar-link ms-3"
            ><i class="fa-solid fa-ticket"></i> Book a tour</a
          >
          <a href="available-tours.html" class="sidebar-link ms-3"
            ><i class="fas fa-list me-2"></i>View Tours</a
          >
          <a href="my-bookings.html" class="sidebar-link ms-3"
            ><i class="fa-solid fa-book"></i> My Bookings</a
          >
  
           <!-- Spacing -->
           <div class="mt-5"></div>
  
          <!-- New Financial Area Section -->
          <div class="mt-5"></div>
          <!-- some spacing -->
  
          <div class="sidebar-section-title">Financial Area</div>
          <a href="financial-area.html" class="sidebar-link ms-3"
            >Financial Area</a
          >
  
          <!-- Spacing -->
          <div class="mt-5"></div>
          
          <!-- Operation Area -->
          <div class="sidebar-section-title">Operation Area</div>
          <a href="operation-area.html" class="sidebar-link ms-3">
            Operation Area
          </a>
          <div class="mt-5"></div>
          <!-- Employee Portal -->
          <div class="sidebar-section-title">Employee Portal</div>
          <a href="employee-area.html" class="sidebar-link ms-3">
            <i class="fa-solid fa-user"></i> Employee Area
          </a>
  
          <!-- Spacing -->
          <div class="mt-5"></div>
  
          <div class="sidebar-section-title">User Area</div>
  
          <!-- Register/Login or Logout Button -->
          <button
            class="btn btn-primary ms-3 mt-3"
            id="registerBtn"
            data-bs-toggle="modal"
            data-bs-target="#registerModal"
          >
            Register
          </button>
          <button
            class="btn btn-secondary ms-3 mt-3"
            id="authBtn"
            data-bs-toggle="modal"
            data-bs-target="#loginModal"
          >
            Login
          </button>
  
          <!-- Welcome Message -->
          <div id="userWelcome" class="text-center mt-3 text-white">
            <!-- Content dynamically updated via JavaScript -->
          </div>
  
  
  
  
        </div>
        <div class="text-center mt-auto">
          <img
            src="assets/logo.png"
            alt="Logo"
            class="img-fluid"
            style="max-width: 80%; height: auto; margin-bottom: 20px"
          />
        </div>
      </div>

      <!-- Registration Modal -->
    <div
    class="modal fade"
    id="registerModal"
    tabindex="-1"
    aria-labelledby="registerModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="registerModalLabel">Register</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <form id="registerForm">
            <div class="mb-3">
              <label for="name" class="form-label">Name</label>
              <input
                type="text"
                id="name"
                name="name"
                class="form-control"
                placeholder="Enter your name"
                required
              />
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input
                type="email"
                id="email"
                name="email"
                class="form-control"
                placeholder="Enter your email"
                required
              />
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input
                type="password"
                id="password"
                name="password"
                class="form-control"
                placeholder="Enter your password"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary w-100">
              Register
            </button>
          </form>
        </div>
        <div class="modal-footer">
          <p class="text-center w-100">
            Already have an account?
            <a href="#" id="switchToLogin">Login</a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div
    class="modal fade"
    id="loginModal"
    tabindex="-1"
    aria-labelledby="loginModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">Login</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label for="loginEmail" class="form-label">Email</label>
              <input
                type="email"
                id="loginEmail"
                name="email"
                class="form-control"
                placeholder="Enter your email"
                required
              />
            </div>
            <div class="mb-3">
              <label for="loginPassword" class="form-label">Password</label>
              <input
                type="password"
                id="loginPassword"
                name="password"
                class="form-control"
                placeholder="Enter your password"
                required
              />
            </div>
            <button type="submit" class="btn btn-secondary w-100">
              Login
            </button>
            <a
              href="#"
              class="text-primary mt-2 d-block"
              data-bs-toggle="modal"
              data-bs-target="#forgotPasswordModal"
              >Forgot Password?</a
            >
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div
    class="modal fade"
    id="forgotPasswordModal"
    tabindex="-1"
    aria-labelledby="forgotPasswordModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="forgotPasswordModalLabel">
            Forgot Password
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <form id="forgotPasswordForm">
            <div class="mb-3">
              <label for="forgotEmail" class="form-label">Email</label>
              <input
                type="email"
                id="forgotEmail"
                name="email"
                class="form-control"
                placeholder="Enter your registered email"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary w-100">
              Send Reset Link
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Reset Password Modal -->
  <div
    class="modal fade"
    id="resetPasswordModal"
    tabindex="-1"
    aria-labelledby="resetPasswordModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resetPasswordModalLabel">
            Reset Password
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <form id="resetPasswordForm">
            <div class="mb-3">
              <label for="newPassword" class="form-label">New Password</label>
              <input
                type="password"
                id="newPassword"
                name="newPassword"
                class="form-control"
                placeholder="Enter your new password"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary w-100">
              Reset Password
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

    <!-- Content -->
    <div class="content">
        <div class="container-fluid">
            <!-- Create Booking Form -->
            <div class="card shadow border-0 mb-4">
                <div class="card-header bg-primary text-white">
                    <h4>Create Booking</h4>
                </div>
                <div class="card-body">
                    <form id="createBookingForm">
                        <!-- Lead Traveler Section -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">Lead Traveler</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="name" class="form-label">Name</label>
                                    <input type="text" id="name" name="name" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="surname" class="form-label">Surname</label>
                                    <input type="text" id="surname" name="surname" class="form-control" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="dob" class="form-label">Date of Birth</label>
                                    <input type="date" id="dob" name="dob" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input type="tel" id="phone" name="phone" class="form-control" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" id="email" name="email" class="form-control" required>
                            </div>
                        </div>

                        <!-- Additional Travelers Section -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">Additional Travelers</h5>
                            <div id="additionalTravelersContainer">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control traveler-name" placeholder="Traveler Name">
                                    <button type="button" class="btn btn-danger remove-traveler-btn">Remove</button>
                                </div>
                            </div>
                            <button type="button" id="addTravelerButton" class="btn btn-secondary">Add Traveler</button>
                        </div>

                        <!-- Tour Details Section -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">Tour Details</h5>
                            <div class="mb-3">
                                <label for="tour" class="form-label">Select Tour</label>
                                <select id="tour" name="tour_id" class="form-control" required></select>
                            </div>
                            <div class="mb-3">
                                <label for="tour_date" class="form-label">Tour Date</label>
                                <input type="datetime-local" id="tour_date" name="tour_date" class="form-control" required>
                            </div>
                        </div>

                        <!-- Special Requirements Section -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">Special Requirements</h5>
                            <textarea id="special_requirements" name="special_requirements" class="form-control" rows="4" placeholder="Enter any special requirements..."></textarea>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">Book</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Populate tours dropdown
        const loadTours = async () => {
            const response = await fetch(`${API_BASE_URL}/tours`);
            const tours = await response.json();
            const tourSelect = document.getElementById('tour');
            tourSelect.innerHTML = tours.map(tour => `<option value="${tour.id}">${tour.name}</option>`).join('');
        };

        // Handle form submission
        document.getElementById('createBookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const payload = Object.fromEntries(formData.entries());

            // Gather additional traveler names
            const travelers = Array.from(document.querySelectorAll('.traveler-name'))
                .map(input => input.value)
                .filter(name => name.trim() !== '');
            payload.additional_travelers = travelers;

            try {
                const response = await fetch(`${API_BASE_URL}/bookings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (response.ok) {
                    alert('Booking created successfully!');
                    e.target.reset();
                    document.getElementById('additionalTravelersContainer').innerHTML = ''; // Clear additional travelers
                } else {
                    alert('Failed to create booking.');
                }
            } catch (err) {
                console.error('Error creating booking:', err);
            }
        });

        // Add and remove additional travelers
        document.getElementById('addTravelerButton').addEventListener('click', () => {
            const container = document.getElementById('additionalTravelersContainer');
            const travelerDiv = document.createElement('div');
            travelerDiv.className = 'input-group mb-2';
            travelerDiv.innerHTML = `
                <input type="text" class="form-control traveler-name" placeholder="Traveler Name">
                <button type="button" class="btn btn-danger remove-traveler-btn">Remove</button>
            `;
            container.appendChild(travelerDiv);
        });

        document.getElementById('additionalTravelersContainer').addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-traveler-btn')) {
                e.target.closest('.input-group').remove();
            }
        });

        loadTours();
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Register script -->
    <script>
      document
        .getElementById("registerForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData.entries());

          try {
            const response = await fetch(`${API_BASE_URL}/users/register`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await response.json();

            if (response.ok) {
              alert("Registration successful!");
              e.target.reset();
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("registerModal")
              );
              modal.hide();
            } else {
              alert(result.message || "Registration failed.");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred.");
          }
        });
    </script>

    <!-- Login script -->
    <script>
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData.entries());

          try {
            const response = await fetch(`${API_BASE_URL}/users/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            const result = await response.json();

            if (response.ok) {
              // Successful login
              console.log("Login successful:", result);
              localStorage.setItem("token", result.token);
              localStorage.setItem("user", JSON.stringify(result.user));
              updateAuthState(); // Update sidebar UI
              alert("Login successful!");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("loginModal")
              );
              modal.hide();
            } else {
              // Login failed
              console.error("Login failed:", result);
              alert(result.error || "Invalid login credentials.");
            }
          } catch (error) {
            console.error("An error occurred during login:", error);
            alert("An error occurred. Please try again later.");
          }
        });
    </script>

    <!-- Forgot pw script -->
    <script>
      document
        .getElementById("forgotPasswordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("forgotEmail").value;

          try {
            const response = await fetch(`${API_BASE_URL}/users/forgot-password`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email }),
            });

            const result = await response.json();
            if (response.ok) {
              alert("Password reset link sent to your email.");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("forgotPasswordModal")
              );
              modal.hide();
            } else {
              alert(result.message || "Failed to send reset link.");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred.");
          }
        });
    </script>

    <!-- Sidebar update script -->
    <script>
      function updateAuthState() {
        const user = JSON.parse(localStorage.getItem("user"));
        const authBtn = document.getElementById("authBtn");
        const userWelcome = document.getElementById("userWelcome");
        const registerBtn = document.getElementById("registerBtn"); // Reference to the Register button

        if (user) {
          // User is logged in
          authBtn.textContent = "Logout";
          authBtn.classList.remove("btn-secondary");
          authBtn.classList.add("btn-danger");
          authBtn.removeAttribute("data-bs-toggle");
          authBtn.removeAttribute("data-bs-target");

          // Disable and gray out the Register button
          registerBtn.disabled = true;
          registerBtn.style.pointerEvents = "none"; // Prevent clicks
          registerBtn.style.backgroundColor = "#6c757d"; // Gray background
          registerBtn.style.borderColor = "#6c757d"; // Match border color
          registerBtn.style.cursor = "not-allowed"; // Show "not allowed" cursor
          registerBtn.textContent = "Register"; // Optional: Update text
          registerBtn.removeAttribute("data-bs-toggle");
          registerBtn.removeAttribute("data-bs-target");

          // Add Welcome message and Reset Password link
          userWelcome.innerHTML = `
                    <div>Welcome, ${user.name}!</div>
                    <a href="#" class="text-white mt-2 d-block" id="resetPasswordLink">Reset Password</a>
                `;
        } else {
          // User is logged out
          authBtn.textContent = "Login";
          authBtn.classList.remove("btn-danger");
          authBtn.classList.add("btn-secondary");
          authBtn.setAttribute("data-bs-toggle", "modal");
          authBtn.setAttribute("data-bs-target", "#loginModal");

          // Enable and restore the Register button
          registerBtn.disabled = false;
          registerBtn.style.pointerEvents = "auto"; // Re-enable clicks
          registerBtn.style.backgroundColor = ""; // Restore default
          registerBtn.style.borderColor = ""; // Restore default
          registerBtn.style.cursor = ""; // Restore default cursor
          registerBtn.textContent = "Register"; // Restore default text
          registerBtn.setAttribute("data-bs-toggle", "modal");
          registerBtn.setAttribute("data-bs-target", "#registerModal");

          userWelcome.textContent = "";
        }
      }

      // Add logout functionality
      document.addEventListener("DOMContentLoaded", () => {
        updateAuthState();

        document.getElementById("authBtn").addEventListener("click", (e) => {
          if (localStorage.getItem("user")) {
            // Logout if user is logged in
            localStorage.clear();
            updateAuthState();
          }
        });
      });
    </script>

    <!-- Reset pw for logged user script -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        updateAuthState();

        // Add logout functionality
        document.getElementById("authBtn").addEventListener("click", (e) => {
          if (localStorage.getItem("user")) {
            // Logout if user is logged in
            localStorage.clear();
            updateAuthState();
          }
        });

        // Add event listener for Reset Password link
        document
          .getElementById("userWelcome")
          .addEventListener("click", (e) => {
            if (e.target.id === "resetPasswordLink") {
              const resetPasswordModal = new bootstrap.Modal(
                document.getElementById("resetPasswordModal")
              );
              resetPasswordModal.show();
            }
          });

        // Handle Reset Password form submission
        document
          .getElementById("resetPasswordForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById("newPassword").value;
            const token = localStorage.getItem("token"); // Use the stored token for authentication

            try {
              const response = await fetch(`${API_BASE_URL}/users/reset-password`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ newPassword }),
              });

              const result = await response.json();
              if (response.ok) {
                alert("Password reset successfully!");
                const modal = bootstrap.Modal.getInstance(
                  document.getElementById("resetPasswordModal")
                );
                modal.hide();
              } else if (result.errors) {
                // Display validation errors
                alert(result.errors.map((err) => err.msg).join("\n"));
              } else {
                alert(result.message || "Password reset failed.");
              }
            } catch (error) {
              console.error("Error:", error);
              alert("An error occurred.");
            }
          });
      });

      // Switch from register to login modal
      document
        .getElementById("switchToLogin")
        .addEventListener("click", (e) => {
          e.preventDefault();

          // Close the Register Modal
          const registerModal = bootstrap.Modal.getInstance(
            document.getElementById("registerModal")
          );
          registerModal.hide();

          // Open the Login Modal
          const loginModal = new bootstrap.Modal(
            document.getElementById("loginModal")
          );
          loginModal.show();
        });
    </script>
</body>
</html>
