<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>External Booking</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.5/index.global.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.5/index.global.min.js"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>

    <style>
      body {
        font-family: "Roboto", sans-serif;
        background-color: #f5f5f5;
      }

      .card-header {
        background: linear-gradient(
          to right,
          #0371e7,
          #012041
        ); /* Gradient background */
        color: white;
        border-radius: 0.5rem 0.5rem 0 0;
        clip-path: polygon(0 0, 100% 0, 100% 70%, 0 100%); /* Angled border */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2), 0 0 15px rgba(0, 91, 187, 0.8); /* Glowing effect */
        padding: 20px;
        position: relative;
        letter-spacing: 2px;
        text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.1);
      }

      .sidebar {
        height: 100vh;
        width: 250px;
        position: fixed;
        top: 0;
        left: 0;
        background: linear-gradient(135deg, #140303, #007bff);
        padding-top: 20px;
        color: white;
        overflow-y: auto;
      }

      .sidebar a {
        text-decoration: none;
        font-size: 1.1rem;
        padding: 10px 20px;
        display: block;
        color: white;
        border-radius: 4px;
      }

      .sidebar a:hover {
        background-color: #007bff;
        color: white;
      }

      .sidebar-section-title {
        font-size: 1rem;
        color: #b0b0b0;
        padding: 5px 20px;
        font-weight: bold;
        text-transform: uppercase;
      }

      .ms-3 {
        margin-left: 1rem;
      }

      .content {
        margin-left: 260px;
        padding: 20px;
      }

      .form-control {
        border-radius: 8px;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
      }

      #main-content .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        font-size: 1rem;
        font-weight: bold;
        color: white;
        border-radius: 8px;
        height: 45px;
        width: 180px;
      }

      .btn-primary:hover {
        background-color: #0056b3;
      }

      .section-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007bff;
        text-transform: uppercase;
        margin-top: 30px;
        margin-bottom: 20px;
      }

      #calendarWrapper {
        display: flex;
        justify-content: center;
        align-items: center; /* Center vertically, if necessary */
      }

      #calendar {
        width: 70%; /* Increase width to make it larger */
        max-width: 900px; /* Set a maximum width for large screens */
        margin: 0 auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Add subtle shadow */
        border-radius: 8px; /* Rounded corners */
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar d-flex flex-column justify-content-between">
      <div>
        <!-- Home -->
        <a href="index.html" class="sidebar-link"
          ><i class="fas fa-home me-2"></i>Home</a
        >

        <!-- Spacing -->
        <div class="mt-5"></div>

        <!-- Product Area -->
        <div class="sidebar-section-title">Product Area</div>
        <a href="product-area.html" class="sidebar-link ms-3"
          ><i class="fa-solid fa-plus"></i> New Experience</a
        >

        <!-- Spacing -->
        <div class="mt-5"></div>

        <!-- Tours Section -->
        <div class="sidebar-section-title">Tours</div>
        <a href="tour-management.html" class="sidebar-link ms-3"
          ><i class="fa-solid fa-plus"></i> Add a New Tour</a
        >
        <a href="available-tours.html" class="sidebar-link ms-3"
          ><i class="fas fa-list me-2"></i>Available Tours</a
        >

        <!-- Spacing -->
        <div class="mt-5"></div>

        <!-- Bookings Section -->
        <div class="sidebar-section-title">Travel Agent Area</div>
        <a href="create-booking.html" class="sidebar-link ms-3"
          ><i class="fa-solid fa-calendar-check"></i> Create Booking</a
        >
        <a href="view-bookings.html" class="sidebar-link ms-3"
          ><i class="fas fa-list me-2"></i>View Bookings</a
        >

        <div class="mt-5"></div>

        <!-- External Booking Section -->
        <div class="sidebar-section-title">Customers Portal</div>
        <a href="external-booking.html" class="sidebar-link ms-3"
          ><i class="fa-solid fa-ticket"></i> Book a tour</a
        >
        <a href="available-tours.html" class="sidebar-link ms-3"
          ><i class="fas fa-list me-2"></i>View Tours</a
        >
        <a href="my-bookings.html" class="sidebar-link ms-3"
          ><i class="fa-solid fa-book"></i> My Bookings</a
        >

        <!-- Spacing -->
        <div class="mt-5"></div>

        <!-- New Financial Area Section -->
        <div class="mt-5"></div>
        <!-- some spacing -->

        <div class="sidebar-section-title">Financial Area</div>
        <a href="financial-area.html" class="sidebar-link ms-3"
          >Financial Area</a
        >

        <!-- Spacing -->
        <div class="mt-5"></div>

        <!-- Operation Area -->
        <div class="sidebar-section-title">Operation Area</div>
        <a href="operation-area.html" class="sidebar-link ms-3">
          Operation Area
        </a>
        <div class="mt-5"></div>
        <!-- Employee Portal -->
        <div class="sidebar-section-title">Employee Portal</div>
        <a href="employee-area.html" class="sidebar-link ms-3">
          <i class="fa-solid fa-user"></i> Employee Area
        </a>

        <!-- Spacing -->
        <div class="mt-5"></div>

        <div class="sidebar-section-title">User Area</div>

        <!-- Register/Login or Logout Button -->
        <button
          class="btn btn-primary ms-3 mt-3"
          id="registerBtn"
          data-bs-toggle="modal"
          data-bs-target="#registerModal"
        >
          Register
        </button>
        <button
          class="btn btn-secondary ms-3 mt-3"
          id="authBtn"
          data-bs-toggle="modal"
          data-bs-target="#loginModal"
        >
          Login
        </button>

        <!-- Welcome Message -->
        <div id="userWelcome" class="text-center mt-3 text-white">
          <!-- Content dynamically updated via JavaScript -->
        </div>
      </div>
      <div class="text-center mt-auto">
        <img
          src="assets/logo.png"
          alt="Logo"
          class="img-fluid"
          style="max-width: 80%; height: auto; margin-bottom: 20px"
        />
      </div>
    </div>

    <!-- Registration Modal -->
    <div
      class="modal fade"
      id="registerModal"
      tabindex="-1"
      aria-labelledby="registerModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="registerModalLabel">Register</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="registerForm">
              <div class="mb-3">
                <label for="name" class="form-label">Name</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  class="form-control"
                  placeholder="Enter your name"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <!--input type="email" id="email" name="email" class="form-control" placeholder="Enter your email" required-->
                <input
                  type="email"
                  id="email"
                  name="email"
                  class="form-control"
                  placeholder="Email"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input
                  type="password"
                  id="password"
                  name="password"
                  class="form-control"
                  placeholder="Enter your password"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary w-100">
                Register
              </button>
            </form>
          </div>
          <div class="modal-footer">
            <p class="text-center w-100">
              Already have an account?
              <a href="#" id="switchToLogin">Login</a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Login Modal -->
    <div
      class="modal fade"
      id="loginModal"
      tabindex="-1"
      aria-labelledby="loginModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">Login</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="loginForm">
              <div class="mb-3">
                <label for="loginEmail" class="form-label">Email</label>
                <input
                  type="email"
                  id="loginEmail"
                  name="email"
                  class="form-control"
                  placeholder="Enter your email"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="loginPassword" class="form-label">Password</label>
                <input
                  type="password"
                  id="loginPassword"
                  name="password"
                  class="form-control"
                  placeholder="Enter your password"
                  required
                />
              </div>
              <button type="submit" class="btn btn-secondary w-100">
                Login
              </button>
              <a
                href="#"
                class="text-primary mt-2 d-block"
                data-bs-toggle="modal"
                data-bs-target="#forgotPasswordModal"
                >Forgot Password?</a
              >
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Forgot Password Modal -->
    <div
      class="modal fade"
      id="forgotPasswordModal"
      tabindex="-1"
      aria-labelledby="forgotPasswordModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="forgotPasswordModalLabel">
              Forgot Password
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="forgotPasswordForm">
              <div class="mb-3">
                <label for="forgotEmail" class="form-label">Email</label>
                <input
                  type="email"
                  id="forgotEmail"
                  name="email"
                  class="form-control"
                  placeholder="Enter your registered email"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary w-100">
                Send Reset Link
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Reset Password Modal -->
    <div
      class="modal fade"
      id="resetPasswordModal"
      tabindex="-1"
      aria-labelledby="resetPasswordModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="resetPasswordModalLabel">
              Reset Password
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="resetPasswordForm">
              <div class="mb-3">
                <label for="newPassword" class="form-label">New Password</label>
                <input
                  type="password"
                  id="newPassword"
                  name="newPassword"
                  class="form-control"
                  placeholder="Enter your new password"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary w-100">
                Reset Password
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="container-fluid">
        <div class="card shadow border-0">
          <div class="card-header bg-primary text-white">
            <h4>Book a Tour</h4>
          </div>
          <div class="card-body" id="main-content">
            <form id="bookingForm">
              <!-- Lead Traveler Section -->
              <div class="section-title">Lead Traveler</div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="name" class="form-label">Name</label>
                  <input
                    type="text"
                    id="name"
                    name="name"
                    placeholder="Name"
                    class="form-control"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="surname" class="form-label">Surname</label>
                  <input
                    type="text"
                    id="surname"
                    name="surname"
                    placeholder="Surname"
                    class="form-control"
                    required
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="dob" class="form-label">Date of Birth</label>
                  <input
                    type="date"
                    id="dob"
                    name="dob"
                    class="form-control"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="phone" class="form-label">Phone Number</label>
                  <div class="intl-tel-input-container">
                    <input
                      type="tel"
                      id="phone"
                      name="phone"
                      class="form-control"
                      required
                    />
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  placeholder="Email"
                  class="form-control"
                  required
                />
              </div>

              <!-- Additional Travelers Section -->
              <div class="section-title">Additional Travelers</div>
              <div id="additionalTravelersContainer">
                <div class="input-group mb-2 traveler">
                  <input
                    type="text"
                    class="form-control"
                    name="travelers[]"
                    placeholder="Traveler Full Name"
                  />
                  <button type="button" class="btn btn-danger remove-traveler">
                    Remove
                  </button>
                </div>
              </div>
              <button
                type="button"
                id="addTraveler"
                class="btn btn-primary mb-4"
              >
                Add Traveler
              </button>

              <!-- Tour Details Section -->
              <div class="section-title">Tour Details</div>
              <div class="mb-3">
                <label for="tour" class="form-label">Select a Tour</label>
                <select id="tour" name="tour_id" class="form-control" required>
                  <option value="">Select a tour</option>
                  <!-- Populate with JS -->
                </select>
              </div>

              <div id="calendarContainer"></div>
              <input type="hidden" id="tour_date" name="tour_date" required />

              <!--div class="mb-3">
                            <label for="tour_date" class="form-label">Tour Date</label>
                            <input type="datetime-local" id="tour_date" name="tour_date" class="form-control" required />
                        </div-->

              <!-- Special Requirements Section -->
              <div class="section-title">Special Requirements</div>
              <div class="mb-3">
                <label for="special_requirements" class="form-label"
                  >Special Requirements</label
                >
                <textarea
                  id="special_requirements"
                  name="special_requirements"
                  rows="4"
                  class="form-control"
                  placeholder="Let us know any special requirements..."
                ></textarea>
              </div>

              <!-- Submit Button -->
              <div class="text-end">
                <button type="submit" class="btn btn-primary">Book Now</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Handle dynamic traveler addition/removal
      const travelersContainer = document.getElementById(
        "additionalTravelersContainer"
      );
      const addTravelerButton = document.getElementById("addTraveler");

      addTravelerButton.addEventListener("click", () => {
        const travelerDiv = document.createElement("div");
        travelerDiv.className = "input-group mb-2 traveler";
        travelerDiv.innerHTML = `
                <input type="text" class="form-control" name="travelers[]" placeholder="Traveler Full Name" />
                <button type="button" class="btn btn-danger remove-traveler">Remove</button>
            `;
        travelersContainer.appendChild(travelerDiv);
      });

      travelersContainer.addEventListener("click", (event) => {
        if (event.target.classList.contains("remove-traveler")) {
          event.target.closest(".traveler").remove();
        }
      });

      const loadTours = async () => {
        const response = await fetch(`${API_BASE_URL}/tours`);
        const tours = await response.json();
        const tourSelect = document.getElementById("tour");

        tourSelect.innerHTML = tours
          .map((tour) => `<option value="${tour.id}">${tour.name}</option>`)
          .join("");
      };

      const loadTourDates = async (tourId) => {
        try {
          const response = await fetch(`${API_BASE_URL}/tours/${tourId}/dates`);
          if (!response.ok) throw new Error("Failed to fetch tour dates.");
          const dates = await response.json();

          if (dates.length === 0) {
            console.warn("No tour dates returned for this tour.");
          }

          console.log("Tour dates fetched:", dates);
          return dates;
        } catch (error) {
          console.error("Error fetching tour dates:", error);
          return []; // Return an empty array if there's an error
        }
      };

      const setupCalendar = (dates) => {
        const calendarEl = document.createElement("div");
        calendarEl.id = "calendar";
        calendarEl.style = "margin-top: 20px;";

        const calendarContainer = document.getElementById("calendarContainer");
        calendarContainer.innerHTML = ""; // Clear existing calendar
        calendarContainer.appendChild(calendarEl);

        const selectedDateDisplay = document.createElement("div");
        selectedDateDisplay.id = "selectedDateDisplay";
        selectedDateDisplay.style =
          "margin-top: 10px; font-weight: bold; color: #007bff;";
        calendarContainer.appendChild(selectedDateDisplay);

        // Ensure `dates` is properly formatted
        console.log("Dates passed to calendar:", dates);

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          events: dates.map(({ date, time }) => ({
            title: time,
            start: `${date}T${time}`,
            allDay: false,
          })),
          eventTimeFormat: {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          },
          eventClick: (info) => {
            const clickedEvent = info.event;
            const selectedDate = clickedEvent.start.toISOString().slice(0, 10);
            const selectedTime = clickedEvent.title;

            document.getElementById(
              "tour_date"
            ).value = `${selectedDate} ${selectedTime}`;
            selectedDateDisplay.textContent = `Selected Slot: ${selectedDate} at ${selectedTime}`;
            selectedDateDisplay.style.color = "green";
          },
        });

        calendar.render();
      };

      document
        .getElementById("tour")
        .addEventListener("change", async (event) => {
          const tourId = event.target.value;

          if (tourId) {
            const dates = await loadTourDates(tourId);
            setupCalendar(dates);
          }
        });

      document.addEventListener("DOMContentLoaded", () => {
        const user = JSON.parse(localStorage.getItem("user"));
        if (user) {
          document.getElementById("email").value = user.email;
        }
      });

      const phoneInput = document.querySelector("#phone");
      const iti = intlTelInput(phoneInput, {
        initialCountry: "auto",
        geoIpLookup: (success, failure) => {
          fetch("https://ipinfo.io/json?token=your_api_token")
            .then((res) => res.json())
            .then((data) => success(data.country))
            .catch(() => failure("us"));
        },
        utilsScript:
          "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
      });

      document
        .getElementById("bookingForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();

          const token = localStorage.getItem("token"); // Retrieve the token

          if (!token) {
            alert("Please log in or create an account first.");
            const registerModal = new bootstrap.Modal(
              document.getElementById("registerModal")
            );
            registerModal.show();
            return;
          }

          phoneInput.value = iti.getNumber();
          const user = JSON.parse(localStorage.getItem("user"));

          const formData = new FormData(event.target);
          const payload = {
            name: formData.get("name"),
            surname: formData.get("surname"),
            email: formData.get("email"),
            phone: formData.get("phone"),
            tour_id: formData.get("tour_id"),
            tour_date: document.getElementById("tour_date").value,
            additional_travelers: JSON.stringify(
              Array.from(document.querySelectorAll('[name="travelers[]"]'))
                .map((input) => input.value.trim())
                .filter((value) => value)
              //.map(input => input.value)
            ),
            special_requirements: formData.get("special_requirements"),
            user_id: user.id,
          };

          try {
            const response = await fetch(`${API_BASE_URL}/bookings`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(payload),
            });

            if (response.ok) {
              const result = await response.json();
              alert(
                `Booking successful! Your Booking ID is ${result.bookingId}`
              );
              event.target.reset();
            } else {
              const error = await response.json();
              alert(`Error: ${error.message}`);
            }
          } catch (error) {
            console.error("Booking error:", error.message);
            alert("Failed to complete the booking. Please try again later.");
          }
        });

      document.addEventListener("DOMContentLoaded", loadTours);
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Register script -->
    <script>
      document
        .getElementById("registerForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData.entries());

          try {
            const response = await fetch(`${API_BASE_URL}/users/register`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await response.json();

            if (response.ok) {
              alert("Registration successful!");
              e.target.reset();
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("registerModal")
              );
              modal.hide();
            } else {
              alert(result.message || "Registration failed.");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred.");
          }
        });
    </script>

    <!-- Login script -->
    <script>
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData.entries());

          try {
            const response = await fetch(`${API_BASE_URL}/users/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            const result = await response.json();

            if (response.ok) {
              // Successful login
              console.log("Login successful:", result);
              localStorage.setItem("token", result.token);
              localStorage.setItem("user", JSON.stringify(result.user));
              updateAuthState(); // Update sidebar UI
              alert("Login successful!");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("loginModal")
              );
              modal.hide();
            } else {
              // Login failed
              console.error("Login failed:", result);
              alert(result.error || "Invalid login credentials.");
            }
          } catch (error) {
            console.error("An error occurred during login:", error);
            alert("An error occurred. Please try again later.");
          }
        });
    </script>

    <!-- Forgot pw script -->
    <script>
      document
        .getElementById("forgotPasswordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("forgotEmail").value;

          try {
            const response = await fetch(`${API_BASE_URL}/users/forgot-password`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email }),
            });

            const result = await response.json();
            if (response.ok) {
              alert("Password reset link sent to your email.");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("forgotPasswordModal")
              );
              modal.hide();
            } else {
              alert(result.message || "Failed to send reset link.");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred.");
          }
        });
    </script>

    <!-- Sidebar update script -->
    <script>
      function updateAuthState() {
        const user = JSON.parse(localStorage.getItem("user"));
        const authBtn = document.getElementById("authBtn");
        const userWelcome = document.getElementById("userWelcome");
        const registerBtn = document.getElementById("registerBtn"); // Reference to the Register button

        if (user) {
          // User is logged in
          authBtn.textContent = "Logout";
          authBtn.classList.remove("btn-secondary");
          authBtn.classList.add("btn-danger");
          authBtn.removeAttribute("data-bs-toggle");
          authBtn.removeAttribute("data-bs-target");

          // Disable and gray out the Register button
          registerBtn.disabled = true;
          registerBtn.style.pointerEvents = "none"; // Prevent clicks
          registerBtn.style.backgroundColor = "#6c757d"; // Gray background
          registerBtn.style.borderColor = "#6c757d"; // Match border color
          registerBtn.style.cursor = "not-allowed"; // Show "not allowed" cursor
          registerBtn.textContent = "Register"; // Optional: Update text
          registerBtn.removeAttribute("data-bs-toggle");
          registerBtn.removeAttribute("data-bs-target");

          // Add Welcome message and Reset Password link
          userWelcome.innerHTML = `
                    <div>Welcome, ${user.name}!</div>
                    <a href="#" class="text-white mt-2 d-block" id="resetPasswordLink">Reset Password</a>
                `;
        } else {
          // User is logged out
          authBtn.textContent = "Login";
          authBtn.classList.remove("btn-danger");
          authBtn.classList.add("btn-secondary");
          authBtn.setAttribute("data-bs-toggle", "modal");
          authBtn.setAttribute("data-bs-target", "#loginModal");

          // Enable and restore the Register button
          registerBtn.disabled = false;
          registerBtn.style.pointerEvents = "auto"; // Re-enable clicks
          registerBtn.style.backgroundColor = ""; // Restore default
          registerBtn.style.borderColor = ""; // Restore default
          registerBtn.style.cursor = ""; // Restore default cursor
          registerBtn.textContent = "Register"; // Restore default text
          registerBtn.setAttribute("data-bs-toggle", "modal");
          registerBtn.setAttribute("data-bs-target", "#registerModal");

          userWelcome.textContent = "";
        }
      }

      // Add logout functionality
      document.addEventListener("DOMContentLoaded", () => {
        updateAuthState();

        document.getElementById("authBtn").addEventListener("click", (e) => {
          if (localStorage.getItem("user")) {
            // Logout if user is logged in
            localStorage.clear();
            updateAuthState();
          }
        });
      });
    </script>

    <!-- Reset pw for logged user script -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        updateAuthState();

        // Add logout functionality
        document.getElementById("authBtn").addEventListener("click", (e) => {
          if (localStorage.getItem("user")) {
            // Logout if user is logged in
            localStorage.clear();
            updateAuthState();
          }
        });

        // Add event listener for Reset Password link
        document
          .getElementById("userWelcome")
          .addEventListener("click", (e) => {
            if (e.target.id === "resetPasswordLink") {
              const resetPasswordModal = new bootstrap.Modal(
                document.getElementById("resetPasswordModal")
              );
              resetPasswordModal.show();
            }
          });

        // Handle Reset Password form submission
        document
          .getElementById("resetPasswordForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById("newPassword").value;
            const token = localStorage.getItem("token"); // Use the stored token for authentication

            try {
              const response = await fetch(`${API_BASE_URL}/users/reset-password`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ newPassword }),
              });

              const result = await response.json();
              if (response.ok) {
                alert("Password reset successfully!");
                const modal = bootstrap.Modal.getInstance(
                  document.getElementById("resetPasswordModal")
                );
                modal.hide();
              } else if (result.errors) {
                // Display validation errors
                alert(result.errors.map((err) => err.msg).join("\n"));
              } else {
                alert(result.message || "Password reset failed.");
              }
            } catch (error) {
              console.error("Error:", error);
              alert("An error occurred.");
            }
          });
      });

      // Switch from register to login modal
      document
        .getElementById("switchToLogin")
        .addEventListener("click", (e) => {
          e.preventDefault();

          // Close the Register Modal
          const registerModal = bootstrap.Modal.getInstance(
            document.getElementById("registerModal")
          );
          registerModal.hide();

          // Open the Login Modal
          const loginModal = new bootstrap.Modal(
            document.getElementById("loginModal")
          );
          loginModal.show();
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Register script -->
    <script>
      document
        .getElementById("registerForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData.entries());

          try {
            const response = await fetch(`${API_BASE_URL}/users/register`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await response.json();

            if (response.ok) {
              alert("Registration successful!");
              e.target.reset();
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("registerModal")
              );
              modal.hide();
            } else {
              alert(result.message || "Registration failed.");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred.");
          }
        });
    </script>

    <!-- Login script -->
    <script>
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData.entries());

          try {
            const response = await fetch(`${API_BASE_URL}/users/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            const result = await response.json();

            if (response.ok) {
              // Successful login
              console.log("Login successful:", result);
              localStorage.setItem("token", result.token);
              localStorage.setItem("user", JSON.stringify(result.user));
              updateAuthState(); // Update sidebar UI
              alert("Login successful!");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("loginModal")
              );
              modal.hide();
            } else {
              // Login failed
              console.error("Login failed:", result);
              alert(result.error || "Invalid login credentials.");
            }
          } catch (error) {
            console.error("An error occurred during login:", error);
            alert("An error occurred. Please try again later.");
          }
        });
    </script>

    <!-- Forgot pw script -->
    <script>
      document
        .getElementById("forgotPasswordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("forgotEmail").value;

          try {
            const response = await fetch(`${API_BASE_URL}/users/forgot-password`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email }),
            });

            const result = await response.json();
            if (response.ok) {
              alert("Password reset link sent to your email.");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("forgotPasswordModal")
              );
              modal.hide();
            } else {
              alert(result.message || "Failed to send reset link.");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred.");
          }
        });
    </script>

    <!-- Sidebar update script -->
    <script>
      function updateAuthState() {
        const user = JSON.parse(localStorage.getItem("user"));
        const authBtn = document.getElementById("authBtn");
        const userWelcome = document.getElementById("userWelcome");
        const registerBtn = document.getElementById("registerBtn"); // Reference to the Register button

        if (user) {
          // User is logged in
          authBtn.textContent = "Logout";
          authBtn.classList.remove("btn-secondary");
          authBtn.classList.add("btn-danger");
          authBtn.removeAttribute("data-bs-toggle");
          authBtn.removeAttribute("data-bs-target");

          // Disable and gray out the Register button
          registerBtn.disabled = true;
          registerBtn.style.pointerEvents = "none"; // Prevent clicks
          registerBtn.style.backgroundColor = "#6c757d"; // Gray background
          registerBtn.style.borderColor = "#6c757d"; // Match border color
          registerBtn.style.cursor = "not-allowed"; // Show "not allowed" cursor
          registerBtn.textContent = "Register"; // Optional: Update text
          registerBtn.removeAttribute("data-bs-toggle");
          registerBtn.removeAttribute("data-bs-target");

          // Add Welcome message and Reset Password link
          userWelcome.innerHTML = `
                    <div>Welcome, ${user.name}!</div>
                    <a href="#" class="text-white mt-2 d-block" id="resetPasswordLink">Reset Password</a>
                `;
        } else {
          // User is logged out
          authBtn.textContent = "Login";
          authBtn.classList.remove("btn-danger");
          authBtn.classList.add("btn-secondary");
          authBtn.setAttribute("data-bs-toggle", "modal");
          authBtn.setAttribute("data-bs-target", "#loginModal");

          // Enable and restore the Register button
          registerBtn.disabled = false;
          registerBtn.style.pointerEvents = "auto"; // Re-enable clicks
          registerBtn.style.backgroundColor = ""; // Restore default
          registerBtn.style.borderColor = ""; // Restore default
          registerBtn.style.cursor = ""; // Restore default cursor
          registerBtn.textContent = "Register"; // Restore default text
          registerBtn.setAttribute("data-bs-toggle", "modal");
          registerBtn.setAttribute("data-bs-target", "#registerModal");

          userWelcome.textContent = "";
        }
      }

      // Add logout functionality
      document.addEventListener("DOMContentLoaded", () => {
        updateAuthState();

        document.getElementById("authBtn").addEventListener("click", (e) => {
          if (localStorage.getItem("user")) {
            // Logout if user is logged in
            localStorage.clear();
            updateAuthState();
          }
        });
      });
    </script>

    <!-- Reset pw for logged user script -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        updateAuthState();

        // Add logout functionality
        document.getElementById("authBtn").addEventListener("click", (e) => {
          if (localStorage.getItem("user")) {
            // Logout if user is logged in
            localStorage.clear();
            updateAuthState();
          }
        });

        // Add event listener for Reset Password link
        document
          .getElementById("userWelcome")
          .addEventListener("click", (e) => {
            if (e.target.id === "resetPasswordLink") {
              const resetPasswordModal = new bootstrap.Modal(
                document.getElementById("resetPasswordModal")
              );
              resetPasswordModal.show();
            }
          });

        // Handle Reset Password form submission
        document
          .getElementById("resetPasswordForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById("newPassword").value;
            const token = localStorage.getItem("token"); // Use the stored token for authentication

            try {
              const response = await fetch(`${API_BASE_URL}/users/reset-password`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ newPassword }),
              });

              const result = await response.json();
              if (response.ok) {
                alert("Password reset successfully!");
                const modal = bootstrap.Modal.getInstance(
                  document.getElementById("resetPasswordModal")
                );
                modal.hide();
              } else if (result.errors) {
                // Display validation errors
                alert(result.errors.map((err) => err.msg).join("\n"));
              } else {
                alert(result.message || "Password reset failed.");
              }
            } catch (error) {
              console.error("Error:", error);
              alert("An error occurred.");
            }
          });
      });

      // Switch from register to login modal
      document
        .getElementById("switchToLogin")
        .addEventListener("click", (e) => {
          e.preventDefault();

          // Close the Register Modal
          const registerModal = bootstrap.Modal.getInstance(
            document.getElementById("registerModal")
          );
          registerModal.hide();

          // Open the Login Modal
          const loginModal = new bootstrap.Modal(
            document.getElementById("loginModal")
          );
          loginModal.show();
        });
    </script>
  </body>
</html>
